<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>掲示板</title>
  <style>
    /* ページ全体のフォント・余白設定 & 背景設定 */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      /* 初期状態は localStorage または後から設定した背景画像が適用される */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: background-image 0.5s ease-in-out;
    }
    #posts {
      list-style-type: none;
      padding: 0;
    }
    .post {
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      position: relative;
    }
    .post-title {
      font-weight: bold;
      font-size: 1.5em;
    }
    .post-content {
      margin-top: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .post-date, .post-number {
      font-size: 0.9em;
      color: #888;
    }
    .post-number {
      position: absolute;
      bottom: 0;
      right: 0;
    }
    .report-button {
      position: absolute;
      top: 0;
      right: 0;
      background-color: #ddd;
      color: #555;
      border: none;
      font-size: 0.8em;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .report-button:hover {
      background-color: #ccc;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 15px;
      margin-top: 10px;
      box-sizing: border-box;
      border-radius: 10px;
      font-size: 16px;
      border: 2px solid #000;
    }
    textarea {
      height: 300px;
      resize: none;
    }
    button {
      background-color: #26a79a;
      color: white;
      padding: 15px 20px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-size: 18px;
    }
    button:hover {
      background-color: #1f877b;
    }

    /* 設定ボタン（カスタム歯車アイコン：直下のSetup.pngを使用）のスタイル */
    .settings-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: rgba(0,0,0,0.6);
      border: none;
      width: 150px;   /* 50pxの3倍 */
      height: 150px;  /* 50pxの3倍 */
      cursor: pointer;
      z-index: 1000;
    }
    /* 設定アイコン画像が押し潰されず、正方形に収まるように */
    .settings-button img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 50%;
    }

    /* モーダルウィンドウのスタイル */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 10px;
    }
    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-modal:hover,
    .close-modal:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    /* 背景候補画像および「なし」オプションのスタイル */
    .bg-option {
      width: 30%;
      margin: 1%;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 5px;
    }
    .bg-option:hover {
      border-color: #26a79a;
    }
    /* 「なし」オプション用のスタイル */
    .none-option {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f0f0f0;
      font-size: 16px;
      color: #333;
      height: 100px;
    }
  </style>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <h1>掲示板</h1>

  <!-- 設定ボタン（カスタム歯車アイコン：直下のSetup.pngを使用） -->
  <button class="settings-button" id="open-settings">
    <img src="Setup.png" alt="設定">
  </button>

  <!-- 背景変更用のモーダル -->
  <div id="background-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="close-modal">&times;</span>
      <h2>背景を選択</h2>
      <div id="bg-options" style="display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center;"></div>
    </div>
  </div>

  <form id="postForm" action="https://script.google.com/macros/s/AKfycbxdCarkggYZJvshEx07ItNVIV2B3zQ4N910AIjWsUyQ_IGCmo51Gceq_uqimJS1C365eA/exec" method="POST">
    <label for="username">ユーザー名:</label>
    <input type="text" id="username" name="username" placeholder="ユーザー名" required>
    <br><br>
    <label for="content">投稿内容:</label>
    <textarea id="content" name="content" placeholder="内容" required></textarea>
    <br><br>
    <div class="g-recaptcha" data-sitekey="6LcEOwIrAAAAAKc6hl6J6doCeY4Nq4qWAEP-Xloh"></div>
    <br>
    <button type="submit">投稿</button>
  </form>
  <hr>
  <ul id="posts"></ul>

  <script>
    // --- 投稿を取得する既存の処理 ---
    async function fetchPosts() {
      const response = await fetch('https://script.google.com/macros/s/AKfycbxdCarkggYZJvshEx07ItNVIV2B3zQ4N910AIjWsUyQ_IGCmo51Gceq_uqimJS1C365eA/exec');
      let posts = await response.json();
      posts = posts.slice(1); // スプレッドシートの項目行を除外
      const postsDiv = document.getElementById("posts");
      postsDiv.innerHTML = ''; // 現在の投稿をクリア

      if (posts.length === 0) {
        postsDiv.innerHTML = `<p>まだ投稿がありません。</p>`;
      } else {
        posts.reverse().forEach((post, index) => { // 最新の投稿を先頭に
          if (post[1] && post[2] && post[0]) {
            const postElement = document.createElement("div");
            postElement.classList.add("post");

            const postNumber = `#${posts.length - index}`;
            const username = post[1];
            const content = post[2].replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const date = new Date(post[0]);
            const formattedDate = isNaN(date) ? "" : date.toLocaleString();
            const reportUrl = `https://docs.google.com/forms/d/e/1FAIpQLSe_gcI4CYjBM-ZGsIR5Q_nd0aquUixz7LixaqzfeuUjEowliQ/viewform?usp=pp_url&entry.1458296354=${encodeURIComponent(postNumber)}`;

            postElement.innerHTML = `
              <p>
                <strong>${username}</strong>: <span class="post-content">${content}</span>
                <br>
                <span class="post-date">${formattedDate}</span>
                <span class="post-number">${postNumber}</span>
                <button class="report-button" onclick="window.open('${reportUrl}', '_blank')">報告</button>
              </p>`;
            postsDiv.appendChild(postElement);
          }
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchPosts(); // 初回の投稿取得
      setInterval(fetchPosts, 5000); // 5秒ごとに更新
    });

    document.getElementById('postForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const button = event.target.querySelector('button');
      button.disabled = true;

      const recaptchaResponse = grecaptcha.getResponse();
      if (!recaptchaResponse) {
        alert("reCAPTCHA認証が完了していません。");
        button.disabled = false;
        return;
      }

      const formData = new FormData(event.target);
      formData.append('g-recaptcha-response', recaptchaResponse);

      await fetch(event.target.action, {
        method: 'POST',
        body: formData
      });

      button.disabled = false;
      event.target.reset();
      grecaptcha.reset();
      fetchPosts(); // 投稿内容を再読み込み
    });

    // --- 背景変更機能の実装 ---
    const settingsButton = document.getElementById('open-settings');
    const modal = document.getElementById('background-modal');
    const closeModal = document.getElementById('close-modal');
    const bgOptionsDiv = document.getElementById('bg-options');

    // 背景候補の配列（背景2までに変更）
    const backgroundCandidates = [
      { label: "なし", file: "none" },
      { label: "背景1", file: "bg1.jpg" },
      { label: "背景2", file: "bg2.jpg" }
    ];

    settingsButton.addEventListener('click', () => {
      modal.style.display = 'block';
      // 以前の背景候補をクリア
      bgOptionsDiv.innerHTML = '';

      // 候補を並べる
      backgroundCandidates.forEach(candidate => {
        let element;
        if(candidate.file === "none"){
          // 「なし」オプションの場合はテキスト表示用のdiv要素を生成
          element = document.createElement('div');
          element.textContent = candidate.label;
          element.className = 'bg-option none-option';
        } else {
          element = document.createElement('img');
          element.src = 'background/' + candidate.file;
          element.alt = candidate.label;
          element.className = 'bg-option';
        }
        // 候補クリックで背景変更＆モーダル閉じる
        element.addEventListener('click', () => {
          if(candidate.file === "none"){
            document.body.style.backgroundImage = "none";
          } else {
            document.body.style.backgroundImage = `url('background/${candidate.file}')`;
          }
          modal.style.display = 'none';
          // 選択内容をlocalStorageに保存
          localStorage.setItem('selectedBackground', candidate.file);
        });
        bgOptionsDiv.appendChild(element);
      });
    });

    // モーダルを閉じる動作
    closeModal.addEventListener('click', () => {
      modal.style.display = 'none';
    });
    // モーダル外をクリックした場合も閉じる
    window.addEventListener('click', (event) => {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    });
    // ページ読み込み時に背景を反映
    window.addEventListener('load', () => {
      const selectedBg = localStorage.getItem('selectedBackground');
      if (selectedBg) {
        if(selectedBg === "none"){
          document.body.style.backgroundImage = "none";
        } else {
          document.body.style.backgroundImage = `url('background/${selectedBg}')`;
        }
      } else {
        // 選択が無い場合、バックグラウンドフォルダ内のデフォルト背景（背景1）を設定
        document.body.style.backgroundImage = `url('background/bg1.jpg')`;
        localStorage.setItem('selectedBackground', 'bg1.jpg');
      }
    });
  </script>
</body>
</html>
